<html>
  <head>
    <!-- CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />

    <!-- jQuery and JS bundle w/ Popper.js -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <script>
      const address = "0xC89B7aEcfEfA090bee0955eB0EFee494231d6Bd0";
      const web3 = new Web3(Web3.givenProvider);

      window.addEventListener("load", async () => {
        if (typeof web3 === "undefined") {
          //return console.log("Metamask is not installed");
          alert("Metamask is not installed, you cannot use this app");
        } else {
          window.ethereum.enable();
          await getAccounts();
        }
      });
      const abi = [
        {
          inputs: [
            { internalType: "uint256", name: "minimum", type: "uint256" },
            { internalType: "address", name: "creator", type: "address" },
          ],
          stateMutability: "payable",
          type: "constructor",
        },
        {
          inputs: [{ internalType: "uint256", name: "index", type: "uint256" }],
          name: "approveRequest",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "", type: "address" }],
          name: "approvers",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "contribute",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "string", name: "description", type: "string" },
            { internalType: "uint256", name: "amount", type: "uint256" },
            { internalType: "address", name: "recipient", type: "address" },
          ],
          name: "createRequest",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "uint256", name: "index", type: "uint256" }],
          name: "finalizeRequest",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "manager",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "minimumContribution",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          name: "requests",
          outputs: [
            { internalType: "string", name: "description", type: "string" },
            { internalType: "uint256", name: "amount", type: "uint256" },
            { internalType: "address", name: "recipient", type: "address" },
            { internalType: "bool", name: "complete", type: "bool" },
            { internalType: "uint256", name: "approvalCount", type: "uint256" },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      let urlString = window.location.href;
      let url = new URL(urlString);
      let campaignAddress = url.searchParams.get("address");

      var campaign = new web3.eth.Contract(abi, campaignAddress);
      var accounts;
      async function getAccounts() {
        accounts = await web3.eth.getAccounts();
      }

      var manager;
      getManager = async () => {
        manager = await campaign.methods.manager().call();
        document.getElementById("manager").innerHTML = manager;
        min = await campaign.methods.minimumContribution().call();
        document.getElementById("minimumContribution").innerHTML = min;
        getRequest();
      };

      getRequest = async () => {
        let element =
          "<table class='table'><thead class='thead-dark'><th>Index</th><th>Description</th><th>Amount</th><th>Status</th><th>Approval Count</th><th>Recipient</th><th>Action</th></tr></thead>";
        let index = 0;

        while (true) {
          try {
            re = await campaign.methods.requests(index).call();
            console.log(re);
            console.log(re.description);

            let status;
            if (re.complete) {
              status =
                "<div class = 'row align-items-center'><h1 class='status text-primary'>&bull;&nbsp;</h1> Complete </div>";
            } else {
              status =
                "<div class = 'row align-items-center'><h1 class='status text-success'>&bull;&nbsp;</h1> Active</div>";
            }

            element +=
              "<tr><td class='align-middle text-center'>" +
              index +
              "</td><td class='align-middle'>" +
              re.description +
              "</td><td class='align-middle'>" +
              re.amount +
              "&nbspwei" +
              "</td><td class='align-middle'>" +
              status +
              "</td><td class='align-middle text-center'>" +
              re.approvalCount +
              "</td><td class='align-middle'>" +
              re.recipient +
              "</td><td class='align-middle'>" +
              '<button type="button" class="btn btn-primary btn-sm mx-1" onclick="approve(' +
              index +
              ')">approve</button>' +
              '<button type="button" class="btn btn-success btn-sm mx-1" onclick="finalize(' +
              index +
              ')">finalize</button>' +
              "</td></tr>";
            index += 1;
          } catch (e) {
            break;
          }
        }
        element += "</table>";
        document.getElementById("request").innerHTML = element;
      };

      contribute = async () => {
        amount = document.getElementById("amount").value;
        const accounts = await web3.eth.getAccounts();
        await campaign.methods.contribute().send({
          from: accounts[0],
          value: web3.utils.toWei(amount, "ether"),
          gas: 1000000,
        });
      };

      createRequest = async () => {
        //string memory description, uint amount, address recipient
        desc = document.getElementById("description").value;
        cona = document.getElementById("conamount").value;
        addr = document.getElementById("address").value;
        const accounts = await web3.eth.getAccounts();

        await campaign.methods.createRequest(desc, cona, addr).send({
          from: accounts[0],
          gas: 1000000,
        });
      };

      approve = async (index) => {
        await campaign.methods
          .approveRequest(index)
          .send({ from: accounts[0], gas: 400000 });
        console.log("approve call from index:" + index);
      };

      finalize = async (index) => {
        await campaign.methods
          .finalizeRequest(index)
          .send({ from: accounts[0], gas: 400000 });
        console.log("call from index:" + index);
      };
    </script>
  </head>

  <body onload="getAccounts()">
    <script>
      getManager();
    </script>

    <nav class="navbar navbar-dark bg-dark text-white">
      <h1 class="mx-auto">Campaign Detail</h1>
    </nav>
    <div class="container-fluid">
      <div
        class="jumbotron jumbotron-fluid text-white jumbotron-image shadow"
        style="
          background-image: url(https://cdn.hipwallpaper.com/i/73/90/9Yk32U.jpg);
        "
      >
        <div class="container">
          <div class="row">
            <div class="col-6">
              <h1 class="display-4">Campaign</h1>
              <p class="lead">
                Contribute to this campaign or create new requrest
              </p>
              <p class="text-warning">Manager Address: <a id="manager"></a></p>
              <p class="text-primary">
                Minimum contribution: <a id="minimumContribution"></a>
              </p>
            </div>
            <div class="col-6">
              <div class="card-transparent ml-auto" style="width: 18rem">
                <div
                  class="card-body"
                  style="
                    background-color: rgba(245, 245, 245, 0.4);
                    border-radius: 20px;
                  "
                >
                  <h3 class="card-title">Contribute</h3>
                  <p class="card-text">Become this campaign contributor.</p>

                  <div class="input-group mb-3">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="wei"
                      aria-describedby="button-addon"
                    />
                    <div class="input-group-append">
                      <button
                        class="btn btn-warning"
                        type="button"
                        id="button-addon"
                        onclick="contribute()"
                      >
                        <b> confirm</b>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row justify-content-center">
        <div class="col-10">
          <div class="table-wrapper shadow">
            <div class="table-title">
              <div class="row">
                <div class="col-sm-8">
                  <h2><b>Request</b> Lists</h2>
                </div>
                <div class="col-sm-4">
                  <button
                    type="button"
                    class="btn btn-primary add-new"
                    data-toggle="modal"
                    data-target="#exampleModal"
                  >
                    <i class="fa fa-plus"></i> Create new Request
                  </button>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="table-responsive px-2" id="request"></div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="exampleModalLabel">
                <b>Create new Request</b>
              </h3>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group px-2">
                <label for="description" class="mt-2">
                  <b>Request description</b></label
                >
                <input
                  type="input"
                  class="form-control"
                  id="description"
                  aria-describedby="descriptionHelp"
                  placeholder="description"
                />
                <small id="descriptionHelp" class="form-text text-muted"
                  >small desctiption or topic about this request</small
                >

                <label for="conamount" class="mt-2"> <b>Amount</b></label>
                <input
                  type="input"
                  class="form-control"
                  id="conamount"
                  aria-describedby="conamountHelp"
                  placeholder="amount (wei)"
                />
                <small id="conamountHelp" class="form-text text-muted"
                  >how much do you want from this request</small
                >

                <label for="address" class="mt-2"><b>Recipient</b></label>
                <input
                  type="input"
                  class="form-control"
                  id="address"
                  aria-describedby="addresstHelp"
                  placeholder="payment address"
                />
                <small id="addressHelp" class="form-text text-muted"
                  >Recipient of this request</small
                >
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="createRequest()"
              >
                Create
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <style>
    body {
      color: #404e67;
      background: #b7abcf;
    }

    .container-fluid {
      padding-right: 0;
      padding-left: 0;
      margin-right: auto;
      margin-left: auto;
    }

    .jumbotron-image {
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
    }

    .table-wrapper {
      margin: 15px auto;
      padding: 30px;
      background: #ffffff;
      border-radius: 50px;
    }
    .table-title {
      padding-bottom: 15px;
      margin: 0 0 10px;
    }
    .table-title h2 {
      margin: 6px 0 0;
      font-size: 35px;
    }
    .table-title .add-new {
      float: right;
      height: 40px;
      font-weight: bold;
      font-size: 20px;
      text-shadow: none;
      min-width: 120px;
      border-radius: 50px;
      line-height: 13px;
    }
    .fa {
      margin-right: 4px;
    }
    .tablebutton {
      float: right;
      height: 30px;
      font-weight: bold;
      font-size: 15px;
      text-shadow: none;
      min-width: 100px;
      border-radius: 50px;
      line-height: 13px;
    }
  </style>
</html>
